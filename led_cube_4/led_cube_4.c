#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "freertos/queue.h"
#include "freertos/event_groups.h"
#include "esp_system.h"
#include "string.h"
#include <stdint.h>
#include <stdbool.h>
#include <stdio.h>
#include "driver/spi_master.h"
#include "driver/gpio.h"

//#define LOG_LOCAL_LEVEL ESP_LOG_INFO
#define PIN_NUM_MISO 19
#define PIN_NUM_MOSI 23
#define PIN_NUM_CLK  18
#define PIN_NUM_CS   22
#define PIN_NUM_CLR  21

uint8_t cube_map[64][3]={
    { 0x0E, 0x01, 0x00 },
    { 0x0E, 0x02, 0x00 },
    { 0x0E, 0x04, 0x00 },
    { 0x0E, 0x08, 0x00 },
    { 0x0E, 0x10, 0x00 },
    { 0x0E, 0x20, 0x00 },
    { 0x0E, 0x40, 0x00 },
    { 0x0E, 0x80, 0x00 },
    { 0x0E, 0x00, 0x01 },
    { 0x0E, 0x00, 0x02 },
    { 0x0E, 0x00, 0x04 },
    { 0x0E, 0x00, 0x08 },
    { 0x0E, 0x00, 0x10 },
    { 0x0E, 0x00, 0x20 },
    { 0x0E, 0x00, 0x40 },
    { 0x0E, 0x00, 0x80 },

    { 0x0D, 0x01, 0x00 },
    { 0x0D, 0x02, 0x00 },
    { 0x0D, 0x04, 0x00 },
    { 0x0D, 0x08, 0x00 },
    { 0x0D, 0x10, 0x00 },
    { 0x0D, 0x20, 0x00 },
    { 0x0D, 0x40, 0x00 },
    { 0x0D, 0x80, 0x00 },
    { 0x0D, 0x00, 0x01 },
    { 0x0D, 0x00, 0x02 },
    { 0x0D, 0x00, 0x04 },
    { 0x0D, 0x00, 0x08 },
    { 0x0D, 0x00, 0x10 },
    { 0x0D, 0x00, 0x20 },
    { 0x0D, 0x00, 0x40 },
    { 0x0D, 0x00, 0x80 },

    { 0x0B, 0x01, 0x00 },
    { 0x0B, 0x02, 0x00 },
    { 0x0B, 0x04, 0x00 },
    { 0x0B, 0x08, 0x00 },
    { 0x0B, 0x10, 0x00 },
    { 0x0B, 0x20, 0x00 },
    { 0x0B, 0x40, 0x00 },
    { 0x0B, 0x80, 0x00 },
    { 0x0B, 0x00, 0x01 },
    { 0x0B, 0x00, 0x02 },
    { 0x0B, 0x00, 0x04 },
    { 0x0B, 0x00, 0x08 },
    { 0x0B, 0x00, 0x10 },
    { 0x0B, 0x00, 0x20 },
    { 0x0B, 0x00, 0x40 },
    { 0x0B, 0x00, 0x80 },

    { 0x07, 0x01, 0x00 },
    { 0x07, 0x02, 0x00 },
    { 0x07, 0x04, 0x00 },
    { 0x07, 0x08, 0x00 },
    { 0x07, 0x10, 0x00 },
    { 0x07, 0x20, 0x00 },
    { 0x07, 0x40, 0x00 },
    { 0x07, 0x80, 0x00 },
    { 0x07, 0x00, 0x01 },
    { 0x07, 0x00, 0x02 },
    { 0x07, 0x00, 0x04 },
    { 0x07, 0x00, 0x08 },
    { 0x07, 0x00, 0x10 },
    { 0x07, 0x00, 0x20 },
    { 0x07, 0x00, 0x40 },
    { 0x07, 0x00, 0x80 }
};

spi_device_handle_t spi;

spi_bus_config_t buscfg={
        .miso_io_num=PIN_NUM_MISO,
        .mosi_io_num=PIN_NUM_MOSI,
        .sclk_io_num=PIN_NUM_CLK,
        .quadwp_io_num=-1,
        .quadhd_io_num=-1,
        .max_transfer_sz=0
 };

 spi_device_interface_config_t devcfg={
        .clock_speed_hz=1*1000*1000,           //Clock out at 100 kHz
        .mode=0,                                //SPI mode
        .spics_io_num=PIN_NUM_CS,               //CS pin
        .queue_size=10,                          //We want to be able to queue 10 transactions at a time
  };


void app_main(void)
{
    gpio_set_direction(PIN_NUM_CLR,GPIO_MODE_OUTPUT);
    gpio_set_level(PIN_NUM_CLR, 0);

    spi_bus_initialize(HSPI_HOST, &buscfg, 0);
    spi_bus_add_device(HSPI_HOST, &devcfg, &spi);
    gpio_set_level(PIN_NUM_CLR, 1);

    spi_transaction_t trans;

    while(1){
        for(uint8_t i=0; i<64; i++){
                memset(&trans, 0, sizeof(trans));
                trans.length = 3*8;
                trans.tx_data[0] = cube_map[i][0];
                trans.tx_data[1] = cube_map[i][1];
                trans.tx_data[2] = cube_map[i][2];
                trans.flags = SPI_TRANS_USE_TXDATA;
                spi_device_transmit(spi, &trans);
                // vTaskDelay(500 / portTICK_PERIOD_MS);
        }
    }

}
